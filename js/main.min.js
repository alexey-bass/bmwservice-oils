/*

 @author Alexey Bass @alexey_bass
 @copyright 2013-2014
*/
(function(h,z){h.App=function(){function x(b,c){function d(a){for(var b=[],c=0,d=-1,f=0,e,g;e=(g=a.charAt(c++)).charCodeAt(0);)e=46==e||48<=e&&57>=e,e!==f&&(b[++d]="",f=e),b[d]+=g;return b}for(var a=d(b),f=d(c),e=0;a[e]&&f[e];e++)if(a[e]!==f[e]){var g=Number(a[e]),h=Number(f[e]);return g==a[e]&&h==f[e]?g-h:a[e]>f[e]?1:-1}return a.length-f.length}var u=0,g={},k="XL";g.init=function(){u=(new Date).getTime();_loadDb();$("#warning button").bind("click",function(){var b=(new Date).getTime()-u;0<b&&ga("send",
"timing","UX","Time before start",b);$("#warning, #screen").hide();$("#screen").removeClass("hidden").fadeIn(1E3);ga("send","screenview",{screenName:"Main"});_updateHeight()});$(h).resize(_updateHeight)};_updateHeight=function(){var b=$(h).height();450<b&&$("#brand ul").height(b-43)};_detectBestImgSize=function(){var b=Math.max($(h).height(),$(h).width());k=700>b?"M":900>b?"L":"XL";$('input[name="image-size"][value='+k+"]").prop("checked",!0)};var e,q=[],r=[],l=[],f,t,m,n,p,v,w;_loadDb=function(){var b=
(new Date).getTime(),c=$('body script[src*="js/main"]').attr("src"),d=c.replace(/^.+\?/,""),c=-1!==c.indexOf(".min.")?"db.min.json":"db.json";$.ajax({dataType:"json",url:c+"?"+d,cache:!0,success:function(a){var c=(new Date).getTime()-b;0<c&&ga("send","timing","Resources","DB loaded",c);e=_prepareDb(a);_populateSelectors(a);_postInit()}})};_prepareDb=function(b){for(var c in b)b[c].id=parseInt(c)+1;return b};_populateSelectors=function(b){var c,d=[],a=[];for(c in b)d.push(b[c].brd),a.push(b[c].sae);
d=unique(d).sort();a=unique(a).sort(x);_populateDiv("brand",d);_populateDiv("sae",a);_populateDiv("tag");_populateDiv("size");_attachHandlers();_detectBestImgSize()};_postInit=function(){t=$("input.type-brand:checkbox ~ span.counter");m=$("input.type-sae:checkbox ~ span.counter");n=$("input.type-poly:radio ~ span.counter");p=$("input.type-clean:radio ~ span.counter");v=$("input.type-chemical:checkbox ~ span.counter");w=$("input.type-synth:checkbox ~ span.counter");_makeDbUsingFilters();g.updateCounters();
$("#sae .header .title").on("click",function(){$("#sae ul").slideToggle()})};_populateDiv=function(b,c){var d,a;a='<div class="header"><span class="title">';switch(b){case "brand":a+="\u0411\u0440\u0435\u043d\u0434\u044b";break;case "sae":a+="SAE";break;case "tag":a+="\u0424\u0438\u043b\u044c\u0442\u0440\u044b";break;case "size":a+="\u041a\u0430\u0440\u0442\u0438\u043d\u043a\u0438"}a+="</span>";"size"!==b&&(a+='<span class="link float-right select-none type-'+b+'" title="\u0421\u043d\u044f\u0442\u044c \u0432\u0441\u0435 \u0433\u0430\u043b\u043e\u0447\u043a\u0438">\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c</span>');
a+="</div>";a+='<ul class="clear">';switch(b){case "tag":a+="<li>";a+="<label>";a+='<input type="checkbox" class="filter type-poly" value="">';a+=' <span class="color-'+b+'">\u043f\u043e\u043b\u0438\u043c\u0435\u0440\u0438\u0437\u0430\u0446\u0438\u044f</span>';a+="</label>";a+="</li>";a+='<li class="color-'+b+' poly-row">';a+='<label class="disabled">';a+='<input type="radio" name="poly" class="filter type-poly" value="1" disabled="disabled">';a+=' <span class="label">\u0434\u0430</span>';a+=' <span class="counter" value="poly-1"></span>';
a+="</label>";a+="<br/>";a+='<label class="disabled">';a+='<input type="radio" name="poly" class="filter type-poly" value="0"  disabled="disabled">';a+=' <span class="label">\u043d\u0435\u0442</span>';a+=' <span class="counter" value="poly-0"></span>';a+="</label>";a+="</li>";a+="<li>";a+="<label>";a+='<input type="checkbox" class="filter type-clean" value="">';a+=' <span class="color-'+b+'">\u0447\u0438\u0441\u0442\u044b\u0439 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442</span>';a+="</label>";
a+="</li>";a+='<li class="color-'+b+' clean-row">';a+='<label class="disabled">';a+='<input type="radio" name="clean" class="filter type-clean" value="1" disabled="disabled">';a+=' <span class="label">\u0434\u0430</span>';a+=' <span class="counter" value="clean-1"></span>';a+="</label>";a+="<br/>";a+='<label class="disabled">';a+='<input type="radio" name="clean" class="filter type-clean" value="0"  disabled="disabled">';a+=' <span class="label">\u043d\u0435\u0442</span>';a+=' <span class="counter" value="clean-0"></span>';
a+="</label>";a+="</li>";a+="<li>";a+="<label>";a+='<input type="checkbox" class="filter type-chemical" value="">';a+=' <span class="color-'+b+'" title="\u0415\u0441\u0442\u044c \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442 \u0438\u0437 \u043b\u0430\u0431\u043e\u0440\u0430\u0442\u043e\u0440\u0438\u0438">\u0445\u0438\u043c. \u0430\u043d\u0430\u043b\u0438\u0437</span>';a+=' <span class="counter" value="chemical-1"></span>';a+="</label>";a+="</li>";a+="<li>";a+="<label>";a+='<input type="checkbox" class="filter type-synth" value="">';
a+=' <span class="color-'+b+'" title="\u0421\u043a\u0440\u044b\u0442\u044c \u043c\u0438\u043d\u0435\u0440\u0430\u043b\u044c\u043d\u044b\u0435 \u0438 \u043f\u043e\u043b\u0443\u0441\u0438\u043d\u0442\u0435\u0442\u0438\u043a\u0443">\u0441\u0438\u043d\u0442\u0435\u0442\u0438\u043a\u0430</span>';a+=' <span class="counter" value="synth"></span>';a+="</label>";a+="</li>";break;case "size":a+='<label title="\u0431\u044b\u0441\u0442\u0440\u043e \u0433\u0440\u0443\u0437\u044f\u0442\u0441\u044f \u043d\u0430 \u0441\u043c\u0430\u0440\u0442\u0444\u043e\u043d\u0435"><input type="radio" name="image-size" value="M" /> \u043c\u0430\u043b\u0435\u043d\u044c\u043a\u0438\u0435</label><br/>';
a+='<label><input type="radio" name="image-size" value="L" /> \u0441\u0440\u0435\u0434\u043d\u0438\u0435</label><br/>';a+='<label><input type="radio" name="image-size" value="XL" /> \u0431\u043e\u043b\u044c\u0448\u0438\u0435</label><br/>';a+='<label title="\u0445\u043e\u0440\u043e\u0448\u0438 \u0434\u043b\u044f \u043f\u0440\u043e\u0441\u043c\u043e\u0442\u0440\u0430 \u043d\u0430 \u0448\u0438\u0440\u043e\u043a\u043e\u0444\u043e\u0440\u043c\u0430\u0442\u043d\u044b\u0445 \u043c\u043e\u043d\u0438\u0442\u043e\u0440\u0430\u0445"><input type="radio" name="image-size" value="XXL"> \u0435\u0449\u0451 \u0431\u043e\u043b\u044c\u0448\u0435</label><br/>';
break;default:for(d in c){a+="<li>";a+="<label>";a+='<input type="checkbox" class="filter type-'+b+'" value="'+c[d]+'">';a+=' <span class="label color-'+b+'">';switch(b){case "sae":a+=c[d].replace("w","w-");break;case "brand":a+=c[d]}a+="</span>";a+=' <span class="counter" value="'+c[d]+'"></span>';a+="</label>";a+="</li>"}}a+="</ul>";$("#"+b).html(a)};_attachHandlers=function(){$("input.filter").bind("change",function(){_updateFilters($(this))});$("span.select-none").bind("click",function(){_uncheckGroup($(this))});
$(document).on("click","span.chemical",function(){_openChemicalWindow($(this))});$(document).on("click","#show-all",function(){ga("send","event","UX","Show all");g.rebuildResults(!0)});$('input[name="image-size"]').on("change",function(){k=_getImageSize();ga("send","event","UX","Image size",k);g.rebuildResults(!0)});"undefined"!==typeof addthis&&(addthis.addEventListener("addthis.ready",_addthisHandler),addthis.addEventListener("addthis.menu.share",_addthisHandler))};var y=0;_addthisHandler=function(b){var c=
(new Date).getTime()-u;switch(b.type){case "addthis.ready":ga("send","timing","Resources","AddThis ready",c);break;case "addthis.menu.share":ga("send","event","social","share",b.data.service,++y),ga("send","timing","UX","Time before pressed share",c,b.data.service)}};_getImageSize=function(){return $('input[name="image-size"]:checked').val()};_openChemicalWindow=function(b){b=b.attr("dbid");b=_getDbItemById(b);var c=h.open("","_blank","menubar=no,location=no,resizable=yes,scrollbars=yes,status=no,height=900,width=820"),
d=b.brd+" "+b.prd+" SAE "+b.sae.replace("w","W-");ga("send","event","UX","Open chemical report",d);d='<html><head><meta charset="utf-8"><title>%TITLE%</title><link rel="stylesheet" href="css/normalize.css"><style>body{margin:0;padding:0;font-size:10pt}</style></head><body><div style="padding: 0 10px"><p>%TEXT%</p><p style="font-size:7pt">\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u0434\u043b\u044f \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u044f \u0449\u0451\u043b\u043e\u0447\u043d\u043e\u0441\u0442\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0441\u044f \u043d\u0435 ASTM-D2896, \u0430 \u0431\u043e\u043b\u0435\u0435 \u0431\u043b\u0438\u0437\u043a\u0438\u0439 \u043a \u043d\u0430\u0448\u0435\u043c\u0443 \u0413\u041e\u0421\u0422 - ASTM D4739, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0434\u0430\u0435\u0442 \u043e\u043a\u043e\u043b\u043e 15% \u0437\u0430\u043d\u0438\u0436\u0435\u043d\u0438\u044f \u0449\u0435\u043b\u043e\u0447\u043d\u043e\u0433\u043e \u0447\u0438\u0441\u043b\u0430. \u0421\u043b\u0435\u0434\u043e\u0432\u0430\u0442\u0435\u043b\u044c\u043d\u043e, \u043f\u043e\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0438 TBN \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0437\u0430\u043d\u0438\u0436\u0435\u043d\u044b \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u043f\u0430\u0441\u043f\u043e\u0440\u0442\u043d\u044b\u0445.<br/>\u0418\u0441\u0441\u043b\u0435\u0434\u043e\u0432\u0430\u043d\u0438\u0435 \u0432 \u0437\u0430\u043a\u0440\u044b\u0442\u043e\u043c \u0442\u0438\u0433\u043b\u0435 \u043e\u0431\u044b\u0447\u043d\u043e \u043f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0441\u044f \u0434\u043b\u044f \u043b\u0435\u0433\u043a\u0438\u0445 \u043d\u0435\u0444\u0442\u0435\u043f\u0440\u043e\u0434\u0443\u043a\u0442\u043e\u0432 - \u044d\u0442\u043e\u0442 \u0442\u0435\u0441\u0442 \u043f\u0440\u043e\u043f\u043e\u0440\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e \u0437\u0430\u043d\u0438\u0436\u0430\u0435\u0442 \u0442\u043e\u0447\u043a\u0443 \u0432\u0441\u043f\u044b\u0448\u043a\u0438 \u043d\u0430 \u0432\u0435\u043b\u0438\u0447\u0438\u043d\u0443 \u043e\u043a\u043e\u043b\u043e 20 \u0433\u0440\u0430\u0434\u0443\u0441\u043e\u0432.<p></div><div><img src="%IMG%" alt="" /></div></body></html>'.replace("%TITLE%",
d);d=d.replace("%TEXT%",b.chm.txt);d=d.replace("%IMG%","//img-fotki.yandex.ru/get/"+b.chm.img+"_XXL");c.document.write(d)};_getDbItemById=function(b){return e[b-1]};_updateFilters=function(b){var c=b.is("input"),d=b.is("[type=radio]"),a=b.is(":checked");switch(b.attr("class").match(/type-(\w+)/)[1]){case "brand":c&&ga("send","event","UX",(a?"S":"Uns")+"elect brand",b.val());d=q;break;case "sae":c&&ga("send","event","UX",(a?"S":"Uns")+"elect SAE",b.val());d=r;break;case "poly":c&&(d?ga("send","event",
"UX","Filter poly",parseInt(b.val())?"Yes":"No"):ga("send","event","UX","Filter poly",a?"Enabled":"Disabled"),$("input[name=poly]:radio").prop("disabled",!a),n.parent()[a?"removeClass":"addClass"]("disabled"));d=[];break;case "clean":c&&(d?ga("send","event","UX","Filter clean result",parseInt(b.val())?"Yes":"No"):ga("send","event","UX","Filter clean result",a?"Enabled":"Disabled"),$("input[name=clean]:radio").prop("disabled",!a),p.parent()[a?"removeClass":"addClass"]("disabled"));d=[];break;case "synth":ga("send",
"event","UX","Filter synt only",a?"Enabled":"Disabled");_disableMineralLabels(a);d=[];break;case "chemical":ga("send","event","UX","Filter has chemical result",a?"Enabled":"Disabled");d=[];break;default:d=[]}c?a?d.push(b.val()):-1!==d.indexOf(b.val())&&remove(d,d.indexOf(b.val())):d.length=0;_makeDbUsingFilters();g.rebuildResults();g.updateCounters()};_disableMineralLabels=function(b){m.parent().has("input[value=10w40], input[value=15w40]").children("input").prop("disabled",b)};g.rebuildResults=function(b){if(b||
q.length||r.length||_filterPolyEnabled()||_filterCleanEnabled()){var c;b="";for(c in l)b+=_makeResultItem(l[c]);$("#results").html(b);$("#show-all").addClass("hidden")}else $("#results").html(""),$("#show-all").removeClass("hidden")};g.updateCounters=function(){var b;t.html("");t.parent().addClass("disabled");for(b in f.brand)t.filter('[value="'+b+'"]').html(f.brand[b]).parent().removeClass("disabled");m.html("");m.parent().addClass("disabled");for(b in f.sae)m.filter('[value="'+b+'"]').html(f.sae[b]).parent().removeClass("disabled");
b=f.poly[0]+f.poly[1];n.filter("[value=poly-1]").html(f.poly[1]?f.poly[1]+" ("+Math.round(100*f.poly[1]/b)+"%)":"");n.filter("[value=poly-0]").html(f.poly[0]?f.poly[0]+" ("+Math.round(100*f.poly[0]/b)+"%)":"");p.filter("[value=clean-1]").html(f.clean[1]||"");p.filter("[value=clean-0]").html(f.clean[0]||"");v.html(f.chemical||"");w.html(f.synth||"")};_filterPolyEnabled=function(){return $("input.type-poly:checkbox").prop("checked")&&$("input[name=poly]:radio:checked").prop("checked")};_filterCleanEnabled=
function(){return $("input.type-clean:checkbox").prop("checked")&&$("input[name=clean]:radio:checked").prop("checked")};_filterChemicalEnabled=function(){return $("input.type-chemical:checkbox").prop("checked")};_filterSynthEnabled=function(){return $("input.type-synth:checkbox").prop("checked")};_makeDbUsingFilters=function(){var b;l=[];f={brand:{},sae:{},poly:{0:0,1:0},clean:{0:0,1:0},chemical:0,synth:0};var c=_filterPolyEnabled(),d=parseInt($("input[name=poly]:radio:checked").val()),a=_filterCleanEnabled(),
g=parseInt($("input[name=clean]:radio:checked").val()),h=_filterChemicalEnabled(),k=_filterSynthEnabled();for(b in e)c&&(e[b].ply||0)!==d||a&&(e[b].cln||0)!==g||k&&0===e[b].syn||h&&!e[b].chm||q.length&&0>q.indexOf(e[b].brd)||r.length&&0>r.indexOf(e[b].sae)||(l.push(e[b]),f.brand[e[b].brd]?f.brand[e[b].brd]++:f.brand[e[b].brd]=1,f.sae[e[b].sae]?f.sae[e[b].sae]++:f.sae[e[b].sae]=1,f.poly[e[b].ply||0]++,f.clean[e[b].cln||0]++,e[b].chm?f.chemical++:0,0!==e[b].syn?f.synth++:0);$("#notes").html("&nbsp;\u041d\u0430\u0448\u043b\u043e\u0441\u044c: "+
l.length+'<br/>&nbsp;<span id="show-all" class="link blue hidden">\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c</span>')};_makeResultItem=function(b){var c;c='<div class="result-item"><h3>';c+='<span class="color-brand">'+b.brd+"</span> "+b.prd+' <span class="color-sae">SAE '+b.sae.replace("w","W-")+"</span>";b.chm&&(c+='&nbsp;&nbsp;&nbsp;<span class="link blue chemical" dbid="'+b.id+'">\u0410\u043d\u0430\u043b\u0438\u0437</span>');if(b.links)for(var d in b.links)c+='&nbsp;&nbsp;&nbsp;<a href="'+
b.links[d].hrf+'" onclick="window.open(this.href); return false;">'+b.links[d].ttl+"</a>";c+="</h3>";c+="<p>"+b.txt+"</p>";c+='<img src="//img-fotki.yandex.ru/get/'+b.img+"_"+k+'" />';return c+="</div>"};_uncheckGroup=function(b){var c=b.parents("div.group").attr("id");ga("send","event","UX","Clear all",c);b.parents("div.group").find("input.filter:checked").prop("checked",!1);"tag"===c&&($("input[name=poly]:radio").prop("checked",!1).prop("disabled",!0),n.parent().addClass("disabled"),$("input[name=clean]:radio").prop("checked",
!1).prop("disabled",!0),p.parent().addClass("disabled"),_disableMineralLabels(!1));_updateFilters(b)};unique=function(b){return $.grep(b,function(c,d){return d===$.inArray(c,b)})};intersect=function(b,c){for(var d=[],a=0;a<b.length;a++)for(var e=0;e<c.length;e++)if(b[a]==c[e]){d.push(b[a]);break}return d};remove=function(b,c,d){d=b.slice((d||c)+1||b.length);b.length=0>c?b.length+c:c;return b.push.apply(b,d)};naturalSort=function(b,c){return+/\d+/.exec(b)[0]>+/\d+/.exec(c)[0]};return g}()})(window);
$(document).ready(function(){App.init()});
